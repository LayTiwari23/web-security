version: "3.9"

services:
  api:
    build:
      context: ..
      dockerfile: docker/api.Dockerfile
    container_name: websec_api_prod
    command: >
      uvicorn src.app.main:app
      --host 0.0.0.0
      --port 8000
      --workers 4
    volumes:
      # ✅ CHANGED: Now maps to your Windows project folder
      - ../pdf_reports:/app/pdf_reports
      - static_files:/app/static
      - ../alembic.ini:/app/alembic.ini
      - ../alembic:/app/alembic
    env_file:
      - ../.env
    environment:
      APP_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://postgres:postgres@websec_db:5432/websec_db}
      REDIS_URL: ${REDIS_URL:-redis://websec_redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://websec_redis:6379/1}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://websec_redis:6379/2}
    depends_on:
      - db
      - websec_redis
    restart: unless-stopped

  worker:
    build:
      context: ..
      dockerfile: docker/api.Dockerfile
    container_name: websec_worker_prod
    command: >
      celery
      -A src.workers.celery_app.celery_app
      worker
      --loglevel=INFO
    volumes:
      # ✅ CHANGED: Ensures Worker saves files directly to your Windows folder
      - ../pdf_reports:/app/pdf_reports
      - ../alembic.ini:/app/alembic.ini
      - ../alembic:/app/alembic
    env_file:
      - ../.env
    environment:
      APP_ENV: production
      PYTHONPATH: .
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://postgres:postgres@websec_db:5432/websec_db}
      REDIS_URL: ${REDIS_URL:-redis://websec_redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://websec_redis:6379/1}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://websec_redis:6379/2}
    depends_on:
      - db
      - websec_redis
    restart: unless-stopped

  beat:
    build:
      context: ..
      dockerfile: docker/api.Dockerfile
    container_name: websec_beat_prod
    command: >
      celery
      -A src.workers.celery_app.celery_app
      beat
      --loglevel=INFO
      -s /tmp/celerybeat-schedule
    env_file:
      - ../.env
    environment:
      APP_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://postgres:postgres@websec_db:5432/websec_db}
      REDIS_URL: ${REDIS_URL:-redis://websec_redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://websec_redis:6379/1}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://websec_redis:6379/2}
    depends_on:
      - db
      - websec_redis
    restart: unless-stopped

  nginx:
    build:
      context: ..
      dockerfile: docker/nginx.Dockerfile
    container_name: websec_nginx_prod
    volumes:
      - static_files:/app/static
      # ✅ CHANGED: Nginx can now serve the PDFs from your Windows folder
      - ../pdf_reports:/app/pdf_reports
      - ../nginx/nginx.conf:/etc/nginx/conf.d/app.conf:ro
    depends_on:
      - api
    ports:
      - "80:80"
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    container_name: websec_db_prod
    networks:
      default:
        aliases:
          - websec_db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=websec_db
    volumes:
      - websec_db_data_prod:/var/lib/postgresql/data
    restart: unless-stopped

  websec_redis:
    image: redis:7-alpine
    container_name: websec_redis_prod
    restart: unless-stopped

volumes:
  websec_db_data_prod:
  static_files:
  # ❌ REMOVED: websec_pdf_reports_prod (no longer needed as a named volume)